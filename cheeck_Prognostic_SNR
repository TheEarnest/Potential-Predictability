#! /bin/ksh
###############################################################################
# check the signal to noise ratio  
#------------------------------------------------------------------------------
# the debug setting has to be change to non-exit because cdo sometimes has 
# the follofing issue "after" it works
# ./cheeck_Prognostic_SNR[71]: .: line 24: 33535: Memory fault(coredump)
# Segmentation fault (core dumped)
#
DebugSetting="set -ex"
ScriptHome=`pwd`
#------------------------------------------------------------------------------
# Parameters
#------------------------------------------------------------------------------
OutputDIR=/scratch/earnest/SyncTransfer/Historical_forcing_ens
DataDIR=/scratch/earnest/noresmexp/Historical_forcing_ens
#O#utputDIR=/scratch/earnest/SyncTransfer/FF_ini_try
#D#ataDIR=/scratch/earnest/noresmexp/FF_ini_try
tempDIR=/scratch/earnest/temp
casePrefix=NorCPM_F19_tn21
MEyear=2000

#ModelCompartments="lnd ocn atm ice"
ModelCompartments="ice"
#------------------------------------------------------------------------------
# Constants
is_revisiting_jobs=1
DIR=${OutputDIR}
#------------------------------------------------------------------------------
funcPath=${ScriptHome}/functions
LinnBreaker="--------------------------------------------------------"
#------------------------------------------------------------------------------
#
if [ ! -d ${DIR} ]; then
  mkdir -p ${DIR}
fi
cd ${DataDIR}
Members=`ls --color=no `
firstMem=`echo ${Members} | awk -F " " '{print $1}'`
lastMem=`echo ${Members} | awk -F " " '{print $NF}'`

${DebugSetting}

for compartment in ${ModelCompartments}; do 
  # check the files
  cd ${DataDIR}/${firstMem}/${compartment}/hist
  #tarFiles=`ls --color=no ${casePrefix}* `
  tempcheck=`ls --color=no *${MEyear}* | awk -F "${MEyear}" '{print $1}'`

  prefixes=""
  is_same_prefix=0
  for prefixCheck in ${tempcheck}; do 
    is_same_prefix=0
    for prefix in ${prefixes}; do 
      if [ "${prefixCheck}" == "${prefix}" ]; then
        is_same_prefix=1
      fi
    done
    if [ "${is_same_prefix}" != "1" ]; then
      prefixes=${prefixes}" "${prefixCheck}
    fi
  done

  #---------------------------------------------------------------------------
  # calculating the ensemble mean/std/spread (max-min)
  for prefix in ${prefixes}; do 
    . ${funcPath}/ps_func_building_ensemble_mean
  #---------------------------------------------------------------------------
  # the difference of each member and ensemble mean
    #------------------------------------------------------------------------
    # for all variables 
    . ${funcPath}/ps_func_check_Diff
    . ${funcPath}/ps_func_check_sqr
    . ${funcPath}/ps_func_check_Spread
    . ${funcPath}/ps_func_check_Signal2NoiseRatio
    # spliting variables
    . ${funcPath}/ps_func_split_variables_check

    if [ "${compartment}" == "atm" ]; then
      # for regional PPP
      ########################################################################
      VarName="SST"
      Mod=${compartment}
      ########################################################################
      # Region define 
      #RegionN="Nino4"; RegLonLat="160,210,-5,5"
      RegionN="Nino34"; RegLonLat="-170,-120,-5,5"
      #RegionN="Nino3"; RegLonLat="-150,-90,-5,5"
      #RegionN="AtlNino3"; RegLonLat="-20,-0,-3,3"
      #RegionN="SPG"; RegLonLat="300,345,48,65"
      #######################################################################
#      . ${funcPath}/ps_func_check_regional_sqr
#      . ${funcPath}/ps_func_check_regional_Spread
#      . ${funcPath}/ps_func_check_regional_Signal2NoiseRatio
    fi
  done
done

if [ "${is_revisiting_jobs}" == "1" ]; then
  . ${funcPath}/ps_func_revisiting_jobs
fi

# http://hugotravel.pixnet.net/blog/post/66203133

