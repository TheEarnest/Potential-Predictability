#! /bin/bash
###############################################################################
# ensemble info
#------------------------------------------------------------------------------
#
set -e
JobStartTime=`date`
JobName=ps_func_building_ensemble_mean
# 
tempPrefix=t_ps_func_building_ensemble_mean
###############################################################################
Mod=${compartment}
mkdir -p ${DIR}/${Mod}/hist_ensmean
mkdir -p ${DIR}/${Mod}/hist_ensspread
mkdir -p ${DIR}/${Mod}/hist_ensstd
cd ${DataDIR}/${firstMem}/${Mod}/hist
files=`ls --color=no ${prefix}*`
for file in ${files}; do
  cd ${DataDIR}
  suffix=`echo ${file} | awk -F "${prefix}" '{print $2}' `
  firstprefix=`echo ${prefix} | awk -F "." '{print $1}'` 
  infix=`echo ${prefix} | awk -F "${firstprefix}" '{print $NF}'`

  echo "Checking ${suffix} of ${Mod} ..."
  Target=${DIR}/${Mod}/hist_ensspread/${casePrefix}${infix}ensspread.${suffix}

  if [ ! -f ${Target} ]; then
    ensTargets=`ls ${casePrefix}_mem??/${Mod}/hist/*${suffix} `
    cdo -O ensmax ${ensTargets} ${tempDIR}/${tempPrefix}_ensmax
    cdo -O ensmin ${ensTargets} ${tempDIR}/${tempPrefix}_ensmin
    cdo -O sub ${tempDIR}/${tempPrefix}_ensmax ${tempDIR}/${tempPrefix}_ensmin ${tempDIR}/${tempPrefix}_Spread
    cp -f ${tempDIR}/${tempPrefix}_Spread ${Target}
  fi
  Target=${DIR}/${Mod}/hist_ensmean/${casePrefix}${infix}ensmean.${suffix}
  if [ ! -f ${Target} ]; then
    ensTargets=`ls ${casePrefix}_mem??/${Mod}/hist/*${suffix} `
    cdo -O ensmean ${ensTargets} ${Target}
  fi
  Target=${DIR}/${Mod}/hist_ensstd/${casePrefix}${infix}ensstd.${suffix}
  if [ ! -f ${Target} ]; then
    cdo -O ensstd ${ensTargets} ${Target}
  fi
exit 1
done
time cdo -O mergetime ${DIR}/${Mod}/hist_ensmean/*${infix}* ${DIR}/${Mod}/${casePrefix}${infix}mergetime
time cdo -O ymonmean ${DIR}/${Mod}/${casePrefix}${infix}mergetime ${DIR}/${Mod}/${casePrefix}${infix}ymonmean
cdo -O sub ${DIR}/${Mod}/${casePrefix}${infix}mergetime ${DIR}/${Mod}/${casePrefix}${infix}ymonmean ${DIR}/${Mod}/${casePrefix}_${infix}_anomaly
cdo -O timvar ${DIR}/${Mod}/${casePrefix}${infix}anomaly ${DIR}/${Mod}/${casePrefix}${infix}anomaly_timvar
months=`cdo showmon ${DIR}/${Mod}/${casePrefix}${infix}anomaly `
for month in `seq 1 12 `; do 
  mm=`echo 00${month} | tail -c3 `
  cdo -O timvar -selmon,${month} ${DIR}/${Mod}/${casePrefix}${infix}anomaly ${DIR}/${Mod}/${casePrefix}${infix}anomaly_timvar_m${mm}
done
###############################################################################
echo ${JobStartTime}
echo `date`" || "${JobName}
echo ${LinnBreaker}





